<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Stock Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      .price-card {
        transition: all 0.3s ease;
      }
      .price-card:hover {
        transform: translateY(-5px);
      }
      .price-up {
        color: #10b981;
      }
      .price-down {
        color: #ef4444;
      }
      .bg-gradient-market {
        background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
      }
      .price-change {
        animation: flash 1s;
      }
      @keyframes flash {
        0% { background-color: rgba(59, 130, 246, 0.3); }
        100% { background-color: transparent; }
      }
    </style>
  </head>
  <body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-gradient-market py-6 shadow-md">
      <div class="container mx-auto px-4">
        <div class="flex justify-between items-center">
          <h1 class="text-3xl md:text-4xl font-bold text-white">
            <i class="fas fa-chart-line mr-2"></i>Stock Tracker
          </h1>
          <a
            href="/"
            class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white py-2 px-4 rounded-lg transition-colors duration-300"
          >
            <i class="fas fa-home mr-2"></i>Home
          </a>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
      <!-- Price Overview -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <!-- Current Price -->
        <div class="price-card bg-white rounded-xl shadow-md p-6">
          <div class="flex justify-between items-center mb-2">
            <h2 class="text-lg text-gray-500">Current Price</h2>
            <span class="text-blue-500">
              <i class="fas fa-coins"></i>
            </span>
          </div>
          <div class="flex items-end">
            <span id="current-price" class="text-3xl font-bold text-gray-800">
              {{ coin_data.price|floatformat:2 }} 
            </span>
            <span id="percent-change" class="ml-2 text-sm {% if percent_change >= 0 %}price-up{% else %}price-down{% endif %}">
                {% if percent_change >= 0 %}
                  <i class="fas fa-caret-up"></i>
                {% else %}
                  <i class="fas fa-caret-down"></i>
                {% endif %}
                {{ percent_change|floatformat:2 }}%
              </span>
          </div>
        </div>

        <!-- 24h High -->
        <div class="price-card bg-white rounded-xl shadow-md p-6">
          <div class="flex justify-between items-center mb-2">
            <h2 class="text-lg text-gray-500">24h High</h2>
            <span class="text-green-500">
              <i class="fas fa-arrow-trend-up"></i>
            </span>
          </div>
          <div class="flex items-end">
            <span id="high-price" class="text-3xl font-bold text-gray-800">
              {{ coin_data.change_24h_high|floatformat:2 }}
            </span>
            <span class="ml-2 text-sm price-up">
              <i class="fas fa-caret-up"></i> High
            </span>
          </div>
        </div>

        <!-- 24h Low -->
        <div class="price-card bg-white rounded-xl shadow-md p-6">
          <div class="flex justify-between items-center mb-2">
            <h2 class="text-lg text-gray-500">24h Low</h2>
            <span class="text-red-500">
              <i class="fas fa-arrow-trend-down"></i>
            </span>
          </div>
          <div class="flex items-end">
            <span id="low-price" class="text-3xl font-bold text-gray-800">
              {{ coin_data.change_24h_low|floatformat:2 }}
            </span>
            <span class="ml-2 text-sm price-down">
              <i class="fas fa-caret-down"></i> Low
            </span>
          </div>
        </div>
      </div>
      <!-- Chart Section -->
      <div class="bg-white rounded-xl shadow-md p-6 mb-8">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-semibold text-gray-800">
            <i class="fas fa-chart-area mr-2"></i>Price History
          </h2>
          <div class="flex items-center">
            <span id="last-update" class="text-sm text-gray-500 mr-4">Last update: Just now</span>
            <button id="refresh-btn" class="bg-blue-500 hover:bg-blue-600 text-white py-1 px-3 rounded-lg text-sm">
              <i class="fas fa-sync-alt mr-1"></i> Refresh
            </button>
          </div>
        </div>
        <div class="h-64">
          <canvas id="priceChart"></canvas>
        </div>
      </div>
      <div>
      </div>
    <script>
      // Initial data for the chart
      const ctx = document.getElementById("priceChart").getContext("2d");
      const list_last_12_coins = [
      {% for coin in list_last_12_coins reversed %}
      {{ coin.price }},
    {% endfor %}
      ];
      const priceChart = new Chart(ctx, {
        type: "line",
        data: {
        labels: list_last_12_coins,
          datasets: [
            {
              label: "Price (USD)",
              data: list_last_12_coins,
              borderColor: "#3B82F6",
              backgroundColor: "rgba(59, 130, 246, 0.1)",
              borderWidth: 2,
              fill: true,
              tension: 0.4,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false,
            },
          },
          scales: {
            y: {
              beginAtZero: false,
              grid: {
                display: true,
                color: "rgba(0, 0, 0, 0.05)",
              },
            },
            x: {
              grid: {
                display: false,
              },
            },
          },
        },
      });

      // Function to fetch latest Bitcoin data
      async function fetchLatestData() {
        try {
          const response = await fetch('/stock/api/bitcoin/latest/');
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          const data = await response.json();
          return data;
        } catch (error) {
          console.error('Error fetching data:', error);
          return null;
        }
      }

      // Function to update UI with new data
      function updateUI(data) {
        if (!data) return;
        
        // Update price elements
        const currentPrice = document.getElementById('current-price');
        const highPrice = document.getElementById('high-price');
        const lowPrice = document.getElementById('low-price');
        const percentChange = document.getElementById('percent-change');
        const lastUpdate = document.getElementById('last-update');
        
        // Add animation class
        currentPrice.classList.add('price-change');
        highPrice.classList.add('price-change');
        lowPrice.classList.add('price-change');
        
        // Update values
        currentPrice.textContent = parseFloat(data.price).toFixed(2);
        highPrice.textContent = parseFloat(data.change_24h_high).toFixed(2);
        lowPrice.textContent = parseFloat(data.change_24h_low).toFixed(2);
        
        // Update percent change
        const percentChangeValue = data.percent_change;
        percentChange.textContent = `${percentChangeValue >= 0 ? '↑' : '↓'} ${Math.abs(percentChangeValue).toFixed(2)}%`;
        percentChange.className = `ml-2 text-sm ${percentChangeValue >= 0 ? 'price-up' : 'price-down'}`;
        
        // Update last update time
        const now = new Date();
        lastUpdate.textContent = `Last update: ${now.toLocaleTimeString()}`;
        
        // Update chart
        priceChart.data.datasets[0].data.push(parseFloat(data.price));
        priceChart.data.datasets[0].data.shift();
        priceChart.update();
        
        // Remove animation class after animation completes
        setTimeout(() => {
          currentPrice.classList.remove('price-change');
          highPrice.classList.remove('price-change');
          lowPrice.classList.remove('price-change');
        }, 1000);
      }

      // Set up auto-refresh
      let refreshInterval;
      
      function startAutoRefresh(interval = 4000) {
        if (refreshInterval) clearInterval(refreshInterval);
        
        refreshInterval = setInterval(async () => {
          const data = await fetchLatestData();
          updateUI(data);
        }, interval);
      }
      
      // Start auto-refresh when page loads (every 10 seconds)
      document.addEventListener('DOMContentLoaded', () => {
        startAutoRefresh();
        
        // Manual refresh button
        document.getElementById('refresh-btn').addEventListener('click', async () => {
          const data = await fetchLatestData();
          updateUI(data);
        });
      });

      // Time filter buttons
      document.querySelectorAll(".time-filter").forEach((button) => {
        button.addEventListener("click", function () {
          // Remove active class from all buttons
          document.querySelectorAll(".time-filter").forEach((btn) => {
            btn.classList.remove("bg-blue-100", "text-blue-600");
            btn.classList.add("bg-gray-100", "text-gray-600");
          });

          // Add active class to clicked button
          this.classList.remove("bg-gray-100", "text-gray-600");
          this.classList.add("bg-blue-100", "text-blue-600");
        });
      });
    </script>
  </body>
</html>
